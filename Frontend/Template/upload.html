<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Dataset - ClickTrain</title>
  <!-- Tailwind is required for header.js (which uses Tailwind classes) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Page-specific styles only ‚Äî header relies on Tailwind from above */
    .hover-lift {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .hover-lift:hover {
      transform: translateY(-2px);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    /* ‚îÄ‚îÄ Drop zone ‚îÄ‚îÄ */
    #dropZone {
      border: 2.5px dashed #d1d5db;
      transition: border-color .2s, background .2s, box-shadow .2s;
    }

    #dropZone:hover,
    #dropZone.drag-over {
      border-color: #6366f1 !important;
      background: #eef2ff !important;
      box-shadow: 0 4px 24px rgba(99, 102, 241, .15);
    }

    /* ‚îÄ‚îÄ Upload progress bar ‚îÄ‚îÄ */
    #uploadProgress {
      display: none;
    }

    .prog-bar-track {
      background: #e5e7eb;
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
    }

    .prog-bar-fill {
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      height: 100%;
      border-radius: 999px;
      width: 0%;
      transition: width .3s ease;
    }

    /* ‚îÄ‚îÄ Preview table ‚îÄ‚îÄ */
    #previewTable thead tr {
      background: #f3f4f6;
    }

    #previewTable th {
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      color: #374151;
      background: #f3f4f6;
      white-space: nowrap;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #previewTable td {
      border: 1px solid #e5e7eb;
      padding: 7px 12px;
      text-align: center;
      font-size: 11px;
      color: #374151;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #previewTable tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    #previewTable tbody tr:hover {
      background: #eef2ff;
      transition: background .1s;
    }

    /* ‚îÄ‚îÄ Error box ‚îÄ‚îÄ */
    #errorBox {
      display: none;
      margin-top: 16px;
      padding: 14px 18px;
      background: #fff1f2;
      border: 1px solid #fca5a5;
      border-radius: 10px;
      font-size: .875rem;
      color: #991b1b;
      font-weight: 600;
    }
  </style>
</head>

<body class="bg-white text-gray-900">
  <div id="ml-header"></div>

  <!-- Main Content -->
  <main class="min-h-screen py-16">
    <div class="max-w-4xl mx-auto px-8 animate-fade-in">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">Upload Your Dataset</h1>
        <p class="text-xl text-gray-600">Start your ML journey by uploading a CSV file</p>
      </div>

      <!-- Upload Area -->
      <div id="dropZone" class="bg-gray-50 rounded-2xl p-12 text-center hover-lift cursor-pointer"
        onclick="document.getElementById('fileInput').click()">
        <div class="text-6xl mb-6">üìÅ</div>
        <h3 class="text-2xl font-semibold mb-4">Drag &amp; Drop Your CSV File</h3>
        <p class="text-gray-500 mb-8">Or click to browse files (max 50MB)</p>
        <input type="file" id="fileInput" accept=".csv" class="hidden">
        <button onclick="event.stopPropagation(); document.getElementById('fileInput').click()"
          class="px-8 py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl font-semibold">
          Choose File
        </button>
      </div>

      <!-- Upload Progress Bar -->
      <div id="uploadProgress" class="mt-6 bg-white rounded-xl p-5 border border-gray-200 shadow-sm">
        <div class="flex justify-between text-sm font-semibold text-gray-700 mb-3">
          <span id="progLabel">Uploading...</span>
          <span id="progPct">0%</span>
        </div>
        <div class="prog-bar-track">
          <div class="prog-bar-fill" id="progFill"></div>
        </div>
      </div>

      <!-- Error Box -->
      <div id="errorBox"></div>

      <!-- File Info Cards -->
      <div id="fileInfo" class="mt-8 hidden">
        <div class="mb-4 text-center">
          <h4 id="fileInfoTitle" class="text-xl font-semibold text-gray-900">
            Information about <span class="font-bold">selected file</span>
          </h4>
        </div>
        <div class="grid gap-4 md:grid-cols-3">
          <!-- Rows -->
          <div
            class="bg-white rounded-2xl p-5 border border-gray-200 shadow-sm flex flex-col justify-center items-center text-center">
            <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Rows</p>
            <p id="rowCount" class="text-3xl font-bold text-indigo-600"></p>
            <p class="text-xs text-gray-500 mt-1">number of rows</p>
          </div>
          <!-- Columns -->
          <div
            class="bg-white rounded-2xl p-5 border border-gray-200 shadow-sm flex flex-col justify-center items-center text-center">
            <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Columns</p>
            <p id="colCount" class="text-3xl font-bold text-indigo-600"></p>
            <p class="text-xs text-gray-500 mt-1">total features</p>
          </div>
          <!-- File Size -->
          <div
            class="bg-white rounded-2xl p-5 border border-gray-200 shadow-sm flex flex-col justify-center items-center text-center">
            <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">File Size</p>
            <p id="fileSize" class="text-xl font-semibold text-gray-900"></p>
            <p class="text-xs text-gray-500 mt-1">file size (MB)</p>
          </div>
        </div>
      </div>

      <!-- Data Preview -->
      <div id="dataPreview" class="mt-8 hidden">
        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
          <div class="flex flex-col items-center mb-4">
            <h4 class="text-lg font-semibold text-center">Data Preview</h4>
            <p class="text-xs text-gray-500 mt-1 text-center">Showing first 5 rows (df.head())</p>
          </div>
          <div class="overflow-x-auto rounded-xl border border-gray-200 bg-gray-50">
            <table id="previewTable" class="min-w-max border-collapse">
              <thead>
                <tr id="previewHeaderRow"></tr>
              </thead>
              <tbody id="tableBody" class="bg-white"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Next Step -->
      <div id="nextStep" class="mt-12 text-center hidden">
        <a id="nextLink" href="Analysis.html"
          class="inline-block px-8 py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl font-semibold text-base">
          Proceed to Analysis ‚Üí
        </a>
      </div>
    </div>
  </main>

  <script>
    const API = 'http://127.0.0.1:8000/api';

    // ‚îÄ‚îÄ Drag & drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add('drag-over');
    }));
    ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove('drag-over');
      if (ev === 'drop' && e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
    }));
    fileInput.addEventListener('change', e => { if (e.target.files[0]) processFile(e.target.files[0]); });

    // ‚îÄ‚îÄ Render UI from state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderUploadState(state, sessionId) {
      const fileInfoTitleEl = document.getElementById('fileInfoTitle');
      const fileSizeEl = document.getElementById('fileSize');
      const rowCountEl = document.getElementById('rowCount');
      const colCountEl = document.getElementById('colCount');
      const headerRow = document.getElementById('previewHeaderRow');
      const tableBody = document.getElementById('tableBody');

      fileInfoTitleEl.innerHTML = 'Information about <span class="font-bold">' + state.fileName + '</span>';
      fileSizeEl.textContent = state.fileSizeMB + ' MB';
      rowCountEl.textContent = state.rowCount;
      colCountEl.textContent = state.colCount;

      headerRow.innerHTML = '';
      tableBody.innerHTML = '';

      const columns = state.columns || [];
      const preview = Array.isArray(state.preview) ? state.preview : [];

      if (columns.length === 0) {
        const row = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 1;
        td.className = 'px-4 py-4 text-center text-gray-500';
        td.textContent = 'Dataset loaded, but no preview is available.';
        row.appendChild(td); tableBody.appendChild(row);
      } else {
        // Build header using DocumentFragment
        const hFrag = document.createDocumentFragment();
        columns.forEach(col => {
          const th = document.createElement('th'); th.textContent = col; th.title = col;
          hFrag.appendChild(th);
        });
        headerRow.appendChild(hFrag);

        // Build rows
        const bFrag = document.createDocumentFragment();
        if (preview.length === 0) {
          const row = document.createElement('tr');
          columns.forEach(() => {
            const td = document.createElement('td'); td.textContent = '‚Äî'; row.appendChild(td);
          });
          bFrag.appendChild(row);
        } else {
          preview.forEach((rowObj, rowIndex) => {
            const row = document.createElement('tr');
            columns.forEach((col, colIndex) => {
              const td = document.createElement('td');
              let value;
              if (rowObj && typeof rowObj === 'object' && !Array.isArray(rowObj)) {
                value = rowObj[col];
              } else if (Array.isArray(rowObj)) {
                value = rowObj[colIndex];
              } else {
                value = rowObj;
              }
              const displayValue = (value === null || value === undefined) ? '' : String(value);
              td.textContent = displayValue; td.title = displayValue;
              row.appendChild(td);
            });
            bFrag.appendChild(row);
          });
        }
        tableBody.appendChild(bFrag);
      }

      document.getElementById('fileInfo').classList.remove('hidden');
      document.getElementById('dataPreview').classList.remove('hidden');
      document.getElementById('nextStep').classList.remove('hidden');
      document.getElementById('nextLink').href = `Analysis.html?session_id=${sessionId}`;
    }

    // ‚îÄ‚îÄ Upload with XHR (real progress bar) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function processFile(file) {
      // Reset previous state
      document.getElementById('errorBox').style.display = 'none';
      document.getElementById('fileInfo').classList.add('hidden');
      document.getElementById('dataPreview').classList.add('hidden');
      document.getElementById('nextStep').classList.add('hidden');

      // Show loading state immediately
      const fileInfoTitleEl = document.getElementById('fileInfoTitle');
      fileInfoTitleEl.innerHTML = 'Information about <span class="font-bold">uploading file...</span>';
      document.getElementById('fileSize').textContent = '';
      document.getElementById('rowCount').textContent = '';
      document.getElementById('colCount').textContent = '';
      document.getElementById('fileInfo').classList.remove('hidden');

      // Progress bar
      const progress = document.getElementById('uploadProgress');
      const progFill = document.getElementById('progFill');
      const progLabel = document.getElementById('progLabel');
      const progPct = document.getElementById('progPct');
      progress.style.display = '';
      progFill.style.width = '2%';
      progLabel.textContent = 'Uploading ' + file.name + '‚Ä¶';
      progPct.textContent = '0%';

      const formData = new FormData();
      formData.append('file', file);

      const xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', e => {
        if (!e.lengthComputable) return;
        const pct = Math.round(e.loaded / e.total * 85); // cap at 85% ‚Äî rest is server
        progFill.style.width = pct + '%';
        progPct.textContent = pct + '%';
      });

      xhr.addEventListener('load', () => {
        progFill.style.width = '100%';
        progPct.textContent = '100%';
        progLabel.textContent = 'Processing‚Ä¶';

        try {
          const data = JSON.parse(xhr.responseText);
          if (xhr.status >= 200 && xhr.status < 300 && data.session_id) {
            localStorage.setItem('session_id', data.session_id);
            console.log('Session ID stored:', data.session_id);

            const state = {
              fileName: file.name,
              fileSizeMB: (file.size / 1024 / 1024).toFixed(2),
              rowCount: Array.isArray(data.shape) ? data.shape[0] : data.shape?.[0],
              colCount: Array.isArray(data.shape) ? data.shape[1] : data.shape?.[1],
              columns: data.columns || [],
              preview: Array.isArray(data.preview) ? data.preview : []
            };
            localStorage.setItem('upload_state', JSON.stringify(state));

            setTimeout(() => {
              progress.style.display = 'none';
              renderUploadState(state, data.session_id);
            }, 300);
          } else {
            showError('Upload failed: ' + (data.detail || 'Unknown error'));
            progress.style.display = 'none';
            document.getElementById('fileInfo').classList.add('hidden');
          }
        } catch (e) {
          showError('Upload failed: could not parse server response.');
          progress.style.display = 'none';
          document.getElementById('fileInfo').classList.add('hidden');
        }
      });

      xhr.addEventListener('error', () => {
        showError('Upload failed. Please check if the backend server is running on port 8000.');
        progress.style.display = 'none';
        document.getElementById('fileInfo').classList.add('hidden');
      });

      xhr.open('POST', API + '/upload');
      xhr.send(formData);
    }

    function showError(msg) {
      const box = document.getElementById('errorBox');
      box.textContent = msg; box.style.display = '';
    }

    // ‚îÄ‚îÄ Restore previous session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function restorePreviousUpload() {
      const storedState = localStorage.getItem('upload_state');
      const sessionId = localStorage.getItem('session_id');
      if (!storedState || !sessionId) return;
      try {
        const state = JSON.parse(storedState);
        if (state && state.fileName) renderUploadState(state, sessionId);
      } catch (e) { /* ignore */ }
    })();
  </script>

  <!-- header.js must come AFTER script tag, uses Tailwind classes -->
  <script src="header.js"></script>
</body>

</html>